# 《炉石传说》游戏规则文档

## 📋 目录

1. [游戏概述](#游戏概述)
2. [基础规则](#基础规则)
3. [实体系统](#实体系统)
4. [区域系统](#区域系统)
5. [序列与阶段系统](#序列与阶段系统)
6. [事件与扳机系统](#事件与扳机系统)
7. [关键词机制](#关键词机制)
8. [战斗系统](#战斗系统)
9. [卡牌使用规则](#卡牌使用规则)
10. [游戏流程](#游戏流程)
11. [高级规则](#高级规则)
12. [错误处理](#错误处理)

---

## 游戏概述

《炉石传说》是一款基于回合制的策略卡牌游戏。两名玩家通过使用卡牌、召唤随从、施放法术和攻击来击败对方的英雄，获得胜利。

### 游戏目标
- 将对手英雄的生命值降至0或以下
- 在特定条件下获得胜利（如任务完成、特殊卡牌效果等）

### 基本组件
- **英雄**：玩家的角色，拥有30点生命值
- **随从**：可以攻击和防御的生物
- **法术**：一次性效果
- **武器**：为英雄提供攻击能力
- **英雄技能**：每回合可使用一次的特殊能力

---

## 基础规则

### 回合结构
每个回合分为以下几个阶段：

1. **准备阶段**：处理回合开始效果
2. **抽牌阶段**：抽取一张卡牌
3. **主阶段**：可以执行主要行动
4. **结束阶段**：处理回合结束效果

### 资源系统
- **法力水晶**：用于支付卡牌费用
- 每回合开始时获得一个法力水晶（最多10个）
- 第一回合先手玩家不获得法力水晶
- 后手玩家获得一张额外的卡牌和幸运币

### 胜利条件
- 对手英雄的生命值降至0或以下
- 对手牌库耗尽且受到疲劳伤害
- 特定卡牌效果导致的胜利

---

## 实体系统

### 实体类型

#### 1. 基础实体 (Entity)
所有游戏对象的基类，包含以下属性：
- `id`: 唯一标识符
- `cardId`: 卡牌标识符
- `controller`: 控制者（玩家1或玩家2）
- `zone`: 所在区域
- `zonePosition`: 区域中的位置
- `tags`: 附加属性集合

#### 2. 游戏实体 (GameEntity)
代表游戏本身，包含：
- 当前回合数
- 当前玩家
- 游戏步骤
- 本回合击杀的随从数量

#### 3. 玩家实体 (PlayerEntity)
代表玩家，包含：
- 生命值和护甲
- 法力水晶数量
- 手牌、牌库、墓地
- 英雄和英雄技能

#### 4. 英雄实体 (HeroEntity)
代表英雄，包含：
- 生命值和最大生命值
- 护甲值
- 攻击力
- 冻结状态

#### 5. 随从实体 (MinionEntity)
代表随从，包含：
- 攻击力和生命值
- 关键词（嘲讽、圣盾等）
- 攻击状态
- 特殊效果

#### 6. 法术实体 (SpellEntity)
代表法术卡牌，包含：
- 法术派系
- 是否为奥秘/任务

#### 7. 武器实体 (WeaponEntity)
代表武器，包含：
- 攻击力和耐久度
- 使用状态

### 实体生命周期
1. **创建**：通过效果或卡牌使用创建
2. **入场**：进入相应的区域
3. **生效**：产生效果
4. **离场**：离开区域（死亡、使用等）
5. **销毁**：完全移除游戏

---

## 区域系统

### 区域类型

#### 1. 战场 (PLAY)
- 随从、英雄、武器存在的区域
- 最多7个随从位置
- 英雄和英雄技能始终存在

#### 2. 手牌 (HAND)
- 玩家手中的卡牌
- 最多10张卡牌
- 超过上限会烧毁卡牌

#### 3. 牌库 (DECK)
- 玩家的牌库
- 理论上无大小限制
- 抽牌时从此区域获取

#### 4. 墓地 (GRAVEYARD)
- 死亡或使用过的卡牌
- 记录死亡信息
- 某些效果可以与之交互

#### 5. 奥秘区 (SECRET)
- 奥秘和任务存在的区域
- 最多5个奥秘
- 对手不可见

#### 6. 除外区 (SETASIDE)
- 被移出游戏的卡牌
- 通常无法再次使用

### 区域操作
- **添加**：将实体放入区域
- **移除**：将实体从区域移除
- **移动**：在不同区域间转移
- **洗牌**：随机排列牌库中的卡牌

---

## 序列与阶段系统

### 序列类型

#### 1. 使用卡牌序列 (PLAY_CARD)
处理卡牌使用的完整流程：
1. **使用阶段**：检查条件、支付费用
2. **结算阶段**：处理卡牌效果
3. **完成阶段**：清理和后续处理

#### 2. 攻击序列 (ATTACK)
处理攻击的完整流程：
1. **攻击前阶段**：检查攻击条件
2. **攻击阶段**：执行攻击
3. **伤害阶段**：计算和处理伤害
4. **攻击后阶段**：处理攻击后效果

#### 3. 回合序列
- **回合开始序列**：处理回合开始效果
- **回合结束序列**：处理回合结束效果

### 阶段系统
每个序列包含多个阶段，按顺序执行：
- 阶段可以包含多个事件
- 阶段间可以插入扳机
- 阶段可以被中断或跳过

---

## 事件与扳机系统

### 事件类型

#### 游戏事件
- `GAME_START`：游戏开始
- `TURN_START`：回合开始
- `TURN_END`：回合结束
- `STEP_CHANGED`：游戏步骤改变

#### 卡牌事件
- `CARD_PLAYED`：卡牌被使用
- `CARD_DRAWN`：卡牌被抽取
- `CARD_DISCARDED`：卡牌被弃置
- `CARD_BURNED`：卡牌被烧毁

#### 随从事件
- `MINION_SUMMONED`：随从被召唤
- `MINION_DIED`：随从死亡
- `MINION_ATTACKED`：随从攻击
- `MINION_DEFENDED`：随从被攻击

#### 伤害与治疗事件
- `DAMAGE_DEALT`：造成伤害
- `DAMAGE_RECEIVED`：受到伤害
- `HEALING_DEALT`：造成治疗
- `HEALING_RECEIVED`：受到治疗

#### 关键词事件
- `BATTLECRY`：战吼
- `DEATHRATTLE`：亡语
- `DIVINE_SHIELD_BREAK`：圣盾破裂
- `TAUNT_ATTACK`：嘲讽被攻击

### 扳机机制

#### 扳机属性
- **事件类型**：监听的事件
- **条件**：触发条件（可选）
- **效果**：触发时执行的效果
- **优先级**：决定触发顺序
- **时机**：BEFORE、AFTER、INSTEAD_OF

#### 扳机优先级
1. **立即触发** (IMMEDIATE)：最高优先级
2. **关键词扳机**：如圣盾、免疫等
3. **一般扳机**：普通效果
4. **低优先级**：如吸血、剧毒等
5. **最低优先级**：如复生、救赎等

#### 扳机触发顺序
1. 按优先级排序
2. 同优先级按入场顺序
3. 考虑区域和控制器

---

## 关键词机制

### 基础关键词

#### 嘲讽 (TAUNT)
- 对手必须先攻击具有嘲讽的随从
- 可以被沉默移除
- 多个嘲讽时可以选择攻击目标

#### 圣盾 (DIVINE_SHIELD)
- 第一次受到伤害时免疫该伤害
- 受到伤害后圣盾消失
- 可以被沉默移除

#### 风怒 (WINDFURY)
- 每回合可以攻击两次
- 超级风怒可以攻击四次
- 需要满足攻击条件

#### 冲锋 (CHARGE)
- 召唤的当回合可以立即攻击
- 不受召唤疲劳影响

#### 突袭 (RUSH)
- 召唤的当回合可以攻击随从
- 不能攻击英雄

#### 吸血 (LIFESTEAL)
- 造成的伤害会为英雄恢复等量生命值
- 对英雄和随从都有效

#### 剧毒 (POISONOUS)
- 对被攻击的随从造成致命伤害
- 无论造成多少伤害

#### 潜行 (STEALTH)
- 不能被选为目标
- 可以被范围效果影响
- 攻击或造成伤害后失去潜行

#### 免疫 (IMMUNE)
- 不会受到伤害
- 不能被选为目标
- 可以被沉默移除

#### 冻结 (FROZEN)
- 下回合不能攻击
- 可以被沉默移除

### 高级关键词

#### 复生 (REBORN)
- 第一次死亡时以1点生命值复活
- 复活后失去复生关键词

#### 法术迸发 (SPELLBURST)
- 在你施放一个法术后触发一次性效果

#### 腐蚀 (CORRUPT)
- 在你使用一张法力值更高的卡牌后升级

#### 荣誉消灭 (HONORABLE_KILL)
- 恰好造成致命伤害时触发额外效果

#### 探底 (DREDGE)
- 查看牌库底的三张卡牌

#### 巨型 (COLOSSAL)
- 随附带特殊部位

---

## 战斗系统

### 攻击规则

#### 攻击条件
1. **随从可以攻击**：
   - 不是召唤疲劳的当回合（无冲锋/突袭）
   - 未被冻结
   - 有攻击力
   - 本回合未攻击（或仍有攻击次数）

2. **攻击目标**：
   - 如果有嘲讽，必须先攻击嘲讽随从
   - 潜行目标不能被选为攻击目标
   - 免疫目标不能被攻击

#### 伤害计算
- **攻击者造成伤害**：等于其攻击力
- **防御者造成伤害**：等于其攻击力（如果也是随从）
- **同时造成伤害**：攻击是双向的

#### 特殊效果处理
- **圣盾**：第一次伤害免疫
- **剧毒**：被攻击的随从立即死亡
- **吸血**：攻击者为英雄恢复生命值
- **荣誉消灭**：恰好致命时触发效果

### 死亡处理

#### 死亡检查
- 生命值降至0或以下
- 被标记为"待销毁"
- 受到致命伤害

#### 死亡处理流程
1. 从战场移除
2. 添加到墓地
3. 创建死亡记录
4. 触发亡语效果
5. 处理死亡扳机

---

## 卡牌使用规则

### 使用条件

#### 基本检查
1. **法力值足够**：当前法力 ≥ 卡牌费用
2. **区域正确**：卡牌在手牌中
3. **目标有效**：如果有目标要求，目标必须有效
4. **区域空间**：战场未满（随从）

#### 特殊限制
- **职业限制**：职业卡牌只能由对应职业使用
- **种族限制**：某些效果只对特定种族有效
- **状态限制**：如沉默、冻结等状态可能影响使用

### 使用流程

#### 1. 使用阶段
- 检查使用条件
- 支付法力费用
- 从手牌移除
- 创建使用序列

#### 2. 结算阶段
- 处理卡牌效果
- 触发相关扳机
- 应用关键词效果

#### 3. 完成阶段
- 清理临时效果
- 处理后续事件
- 检查游戏状态

### 卡牌类型处理

#### 随从卡牌
1. 召唤到战场
2. 处理战吼效果
3. 处理召唤扳机
4. 检查战场限制

#### 法术卡牌
1. 处理法术效果
2. 触发法术扳机
3. 送入墓地
4. 处理法术迸发

#### 武器卡牌
1. 装备武器
2. 移除旧武器（如果有）
3. 处理装备效果

---

## 游戏流程

### 游戏初始化

#### 1. 创建玩家
- 创建两个玩家实体
- 分配玩家ID（1和2）
- 初始化玩家属性

#### 2. 创建英雄
- 为每个玩家创建英雄
- 设置初始生命值（30）
- 创建英雄技能

#### 3. 构建牌库
- 根据卡组列表创建卡牌
- 将卡牌添加到牌库
- 洗牌

#### 4. 初始抽牌
- 先手玩家抽3张牌
- 后手玩家抽4张牌并获得幸运币
- 决定先手玩家

### 回合流程

#### 回合开始
1. 增加回合计数
2. 更新游戏步骤
3. 增加法力水晶
4. 重置过载
5. 抽牌
6. 处理回合开始效果

#### 主阶段
玩家可以执行以下操作：
- 使用手牌中的卡牌
- 命令随从攻击
- 使用英雄技能
- 结束回合

#### 回合结束
1. 处理回合结束效果
2. 清除临时效果
3. 切换当前玩家
4. 检查游戏结束

### 游戏结束

#### 胜利判定
- 对手英雄生命值降至0或以下
- 对手受到疲劳伤害而死亡

#### 平局条件
- 双方英雄同时死亡
- 达到最大回合数（90回合）

---

## 高级规则

### 序列嵌套
- 序列可以嵌套执行
- 内层序列优先完成
- 外层序列继续执行

### 效果链
- 效果可以触发其他效果
- 形成连锁反应
- 需要正确处理优先级

### 状态管理
- 实体可以有多种状态
- 状态可以相互影响
- 状态有持续时间

### 光环效果
- 持续影响其他实体
- 实时更新
- 可以被沉默

### 复制与变形
- 实体可以被复制
- 实体可以被变形
- 保持原有属性和效果

---

## 错误处理

### 错误类型

#### 1. 无效操作 (INVALID_OPERATION)
- 不符合游戏规则的操作
- 如攻击无法攻击的目标
- 使用无法使用的卡牌

#### 2. 法力不足 (INSUFFICIENT_MANA)
- 当前法力值不足以支付费用
- 需要考虑过载等效果

#### 3. 无效目标 (INVALID_TARGET)
- 目标不符合要求
- 如需要随从但目标是英雄

#### 4. 区域已满 (ZONE_FULL)
- 目标区域已达到容量上限
- 如战场已满（7个随从）

#### 5. 卡牌未找到 (CARD_NOT_FOUND)
- 请求的卡牌不存在
- 如手牌索引超出范围

#### 6. 实体未找到 (ENTITY_NOT_FOUND)
- 请求的实体不存在
- 如ID对应的实体已销毁

### 错误处理策略
1. **预防性检查**：在执行前验证条件
2. **异常抛出**：发现错误时立即抛出异常
3. **状态回滚**：操作失败时回滚到之前状态
4. **错误记录**：记录错误信息用于调试

---

## 性能优化

### 实体管理
- 使用对象池复用实体
- 及时清理无用实体
- 高效查找和访问

### 事件系统
- 事件分发优化
- 扳机筛选机制
- 避免不必要的事件创建

### 序列管理
- 序列缓存
- 阶段复用
- 高效的排序算法

---

## 扩展性设计

### 模块化架构
- 清晰的模块边界
- 依赖注入
- 接口隔离

### 插件系统
- 支持自定义关键词
- 可扩展的效果系统
- 灵活的配置机制

### 数据驱动
- 配置化规则
- 可热更新的卡牌数据
- 动态加载机制

---

## 测试策略

### 单元测试
- 测试单个类和函数
- 验证边界条件
- 模拟依赖项

### 集成测试
- 测试模块间交互
- 验证完整流程
- 测试错误处理

### 规则测试
- 验证具体游戏规则
- 测试关键词效果
- 验证复杂交互

### 性能测试
- 大规模实体处理
- 高频事件处理
- 内存使用监控

---

## 调试工具

### 日志系统
- 详细的事件日志
- 状态变化追踪
- 性能指标记录

### 调试接口
- 游戏状态查询
- 实体信息查看
- 历史记录回放

### 可视化工具
- 游戏状态可视化
- 事件流图表
- 性能分析图表

---

## 总结

本规则文档详细描述了《炉石传说》游戏的核心机制，包括：

1. **完整的实体系统**：支持所有类型的游戏对象
2. **灵活的区域管理**：处理卡牌的流动和位置
3. **强大的事件系统**：支持复杂的效果交互
4. **完善的战斗机制**：处理攻击、伤害和治疗
5. **丰富的关键词**：实现各种特殊效果
6. **严谨的序列管理**：确保规则正确执行

这套规则系统为：
- ✅ **完整的游戏实现**：支持基础游戏流程
- ✅ **可扩展的架构**：易于添加新机制
- ✅ **类型安全**：完整的TypeScript类型支持
- ✅ **高性能**：优化的数据结构和算法
- ✅ **可测试**：模块化的设计便于测试

通过这套规则系统，可以实现一个完全符合官方规则的《炉石传说》游戏引擎，为玩家提供真实的游戏体验。